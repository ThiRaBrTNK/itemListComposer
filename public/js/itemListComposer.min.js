(function(e){e.fn.itemListComposer=function(t){var n=e.extend({itemSource:".source",itemReceiver:".receiver",itemReceiverOrderable:true,item:"li",selectItem:".select",selectAllItems:".select-all",deselectItem:".deselect",deselectAllItems:".deselect-all",shiftUpButton:".order-up",shiftDownButton:".order-down",acceptorTemplate:"#acceptor",acceptorClass:"acceptor",selectedClass:"selected",draggedClass:"dragged",droppableClass:"droppable",onSelect:function(){},onDeselect:function(){}},t);return this.each(function(){function g(i,s){if(s.is(n.itemSource)||s.is(n.itemReceiver)&&!n.itemReceiverOrderable){var o=s.clone(true);o.append(o.append(i).find(n.item).sort(function(t,n){return e(t).text().toUpperCase().localeCompare(e(n).text().toUpperCase())}));s.replaceWith(o);S(i);n.onDeselect(i)}else{s.append(i);S(i);n.onSelect(i)}t=e(c).find(n.itemSource);r=e(c).find(n.itemReceiver)}function y(t){var r=e(t).prev();if(!r.hasClass(n.selectedClass)){r.before(t)}}function b(t){var r=e(t).next();if(!r.hasClass(n.selectedClass)){r.after(t)}}function w(e){e.find("."+n.acceptorClass).remove()}function E(){return l.clone()}function S(t){t.each(function(){var t=m;var r=v;var i=e(this).parents(n.itemSource);if(!i.length){t=v;r=m}for(var s in t){e(this).off(s)}for(var s in r){e(this).on(s+".itemListComposer",m[s])}})}function x(e){var t=e.parents(n.itemSource);if(!t.length){t=e.parents(n.itemReceiver)}return t}var t=e(this).find(n.itemSource);var r=e(this).find(n.itemReceiver);var i=e(this).find(n.selectItem);var s=e(this).find(n.selectAllItems);var o=e(this).find(n.deselectItem);var u=e(this).find(n.deselectAllItems);var a=e(this).find(n.shiftUpButton);var f=e(this).find(n.shiftDownButton);var l=e(e(this).find(n.acceptorTemplate).get(0).content);var c=this;var h;var p=null;var d=e([]);t.add(r).add(t.find(n.item)).add(r.find(n.item)).add(i).add(o).add(s).add(u).add(a).add(f).off(".itemListComposer");var v={};var m={"dragover.itemListComposer":function(t){t.preventDefault();var i=t.originalEvent.pageY-e(this).offset().top;var s=e(this).outerHeight()/2;if(n.itemReceiverOrderable){if(i<=s&&!e(this).prev().hasClass(n.acceptorClass)){w(r);e(this).before(E())}else if(i>s&&!e(this).next().hasClass(n.acceptorClass)){w(r);e(this).after(E())}}}};t.append(t.find(n.item).sort(function(t,n){return e(t).text().toUpperCase().localeCompare(e(n).text().toUpperCase())}));if(!n.itemReceiverOrderable){r.append(r.find(n.item).sort(function(t,n){return e(t).text().toUpperCase().localeCompare(e(n).text().toUpperCase())}))}S(r.find(n.item));t.add(r).find(n.item).on("click.itemListComposer",function(t){if(t.shiftKey&&undefined!==h){var r=Math.min(e(this).index(),h.index());var i=Math.max(e(this).index(),h.index());var s=e(this).siblings().slice(r,i);s.add(this).addClass(n.selectedClass)}else{e(this).toggleClass(n.selectedClass)}h=e(this)}).on("dragstart.itemListComposer",function(t){var r=x(e(this));d=r.find("."+n.selectedClass).add(e(this));d.addClass(n.draggedClass+" "+n.selectedClass);t.originalEvent.dataTransfer.setData("text/plain","Dragndrop now works in stinky bastard FF")}).on("dragend.itemListComposer",function(){d.removeClass(n.draggedClass);r.add(t).removeClass(n.droppableClass)}).on("selectstart.itemListComposer",function(){this.dragDrop();return false});r.add(t).on("dragleave.itemListComposer",function(t){if(!p||p===t.target){e(this).removeClass(n.droppableClass);w(e(this))}p=null}).on("dragenter.itemListComposer",function(t){t.preventDefault();p=t.target;var r=x(d.first());if(p===this&&e(this).is(n.itemReceiver)){var i=e(this).find(n.item).last();if(!i.hasClass(n.acceptorClass)&&n.itemReceiverOrderable){w(e(this));i.after(E())}}if(r.is(n.itemReceiver)||e(this).is(n.itemReceiver)){e(this).addClass(n.droppableClass)}}).on("dragover.itemListComposer",function(e){e.preventDefault()}).on("drop.itemListComposer",function(i){i.preventDefault();d.removeClass(n.draggedClass);r.add(t).removeClass(n.droppableClass);if(e(this).is(n.itemSource)&&x(d.first()).is(n.itemSource)){return}if(e(this).is(n.itemReceiver)&&x(d.first()).is(n.itemReceiver)&&!n.itemReceiverOrderable){return}var s=e(this).find("."+n.acceptorClass);g(d,e(this));if(e(this).is(n.itemReceiver)&&n.itemReceiverOrderable){s.replaceWith(d)}else{w(t)}});i.on("click.itemListComposer",function(){var e=t.find(n.item+"."+n.selectedClass);g(e,r)});s.on("click.itemListComposer",function(){var e=t.find(n.item);g(e,r)});o.on("click.itemListComposer",function(){var e=r.find(n.item+"."+n.selectedClass);g(e,t)});u.on("click.itemListComposer",function(){var e=r.find(n.item);g(e,t)});if(n.itemReceiverOrderable){a.on("click.itemListComposer",function(){r.find(n.item+"."+n.selectedClass).each(function(){y(e(this))})});f.on("click.itemListComposer",function(){e(r.find(n.item+"."+n.selectedClass).get().reverse()).each(function(){b(e(this))})})}})}})(jQuery)